define(["local_wizardcategories/jquery","local_wizardcategories/bootstrap","local_wizardcategories/sweetalert","local_wizardcategories/jqueryui"],function(a,b){return{init:function(){function c(b,c,d){a.ajax({type:"POST",data:{course:b,element:c,type_e:d,type:"loadParentCat"},url:"processing.php",success:function(b){alert("si!"),console.log(b),a("#padre").html(b.html)},dataType:"json",cache:"false",error:function(a){console.log("ajax error"),console.log(a)}})}function d(c,d,e){a.ajax({type:"POST",data:{type_ajax:"deleteElement",id:c,courseid:d,type:e},url:"../managers/grade_categories/grader_processing.php",success:function(a){b({title:"Listo",text:a.msg,type:"success",showCancelButton:!1,showConfirmButton:!1,timer:1200}),f(d)},dataType:"json",cache:"false",error:function(a){console.log(a)}})}function e(){for(var a=window.location.search.split("="),b=0;b<a.length;b+=2)if("?id"==a[b])var c=a[b+1];return c}function f(b){a.ajax({type:"POST",data:{course:b,type:"loadCat"},url:"../managers/grade_categories/grader_processing.php",success:function(b){a("#mymodalbody").html(b)},dataType:"text",cache:"false",error:function(a){console.log(a)}})}function g(c,d){var g=a("#tipoItem").val(),l=e();if("CATEGORÍA"==g){if(k(c)){var m=a.trim(a("#inputNombre").val()),n=a("#inputValor").val(),o=h(a("#tipoCalificacion").prop("selectedIndex"));a.ajax({type:"POST",data:{course:l,parent:d,fullname:m,agregation:o,tipo:g,peso:n},url:"../managers/grade_categories/grader_processing.php",success:function(a){1==a?(b({title:"Categoria añadida con exito",html:!0,type:"success",confirmButtonColor:"#d51b23"}),f(l)):0==a&&b({title:"Error al añadir la categoria (server error)",html:!0,type:"error",confirmButtonColor:"#d51b23"})},cache:"false",error:function(a){b({title:"Error al intentar añadir la categoria",html:!0,type:"error",confirmButtonColor:"#d51b23"}),console.log(a)}})}}else if("ÍTEM"==g){if(i(c)){var m=a.trim(a("#inputNombre").val()),n=a("#inputValor").val();a.ajax({type:"POST",data:{course:l,parent:d,fullname:m,tipo:g,peso:n},url:"../managers/grade_categories/grader_processing.php",success:function(a){1==a?(b({title:"item añadido con exito",html:!0,type:"success",confirmButtonColor:"#d51b23"}),f(l)):0==a&&b({title:"Error al añadir el item (server error)",html:!0,type:"error",confirmButtonColor:"#d51b23"})},cache:"false",error:function(a){b({title:"Error al intentar añadir el item",html:!0,type:"error",confirmButtonColor:"#d51b23"}),console.log(a)}})}}else if("PARCIAL"==g){if(j(c)){var m=a.trim(a("#inputNombre").val()),n=a("#inputValor").val();a.ajax({type:"POST",data:{course:l,parent:d,fullname:m,agregation:6,tipo:g,peso:n},url:"../managers/grade_categories/grader_processing.php",success:function(a){1==a?(b({title:"Categoria añadida con exito",html:!0,type:"success",confirmButtonColor:"#d51b23"}),f(l)):0==a&&b({title:"Error al añadir la categoria (server error)",html:!0,type:"error",confirmButtonColor:"#d51b23"})},cache:"false",error:function(a){b({title:"Error al intentar añadir la categoria",html:!0,type:"error",confirmButtonColor:"#d51b23"}),console.log(a)}})}}else b({title:"Seleccione el tipo de elemento que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}function h(a){switch(a){case 1:return 0;case 2:return 10}}function i(c){var d=a.trim(a("#inputNombre").val());if(""==d)return b({title:"Ingrese el nombre del ítem que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;if(10==c){var e=a("#inputValor").val();if(""==e)return b({title:"Ingrese un peso válido entre 0 y 100",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1}return!0}function j(c){var d=a.trim(a("#inputNombre").val());if(""==d)return b({title:"Ingrese el nombre del parcial que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;if(10==c){var e=a("#inputValor").val();if(""==e)return b({title:"Ingrese un peso válido entre 0 y 100",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1}return!0}function k(c){if(0==a("#tipoCalificacion").prop("selectedIndex"))return b({title:"Seleccione el tipo de calificación de la categoría que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;var d=a.trim(a("#inputNombre").val());if(""==d)return b({title:"Ingrese el nombre de la categoría que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;if(10==c){var e=a("#inputValor").val();if(""==e)return b({title:"Ingrese un peso válido entre 0 y 100",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1}return!0}var l;a(document).on("click",".mymodal-close",function(){location.reload(),a(".fondo").hide()}),a(document).on("click",".edit",function(){var b=a(this).attr("title");a("#titulo").text(b);var d=!1;a("#nombre_editar").show(),a("#label_nombre").show(),a("#alta").show(),a("#div_padres").show(),a(this).hasClass("curso")&&(d=!0,a("#alta").hide(),console.log("CURSO"),a("#nombre_editar").hide(),a("#label_nombre").hide(),a("#div_padres").hide());var f=e(),g=a(this).attr("id");if(a("#save_edit").attr("name",g),"Editar Categoría"===b){a("#type_cal").show();var h=a(this).parent().parent().attr("id");a("#otro").hide(),10!=h&&0!=h&&6!=h&&(h=99,a("#otro").show()),a("#calific").prop("value",h);var i="cat",j=a(this).parent().parent().text();if(j.search("-")==-1){var k=j.split("(");j=k[0],n=k[1],d||a("#peso").show(),n=n.replace("(",""),n=n.replace(")",""),n=n.replace(" ",""),n=n.replace("%",""),l=n,a("#peso_editar").val(n);var m=a(this).attr("data-maxweight");a(".maxweight-edit").attr("id",m)}else j=j.split("-")[0],a("#peso").hide()}else{a("#type_cal").hide();var n=a(this).parent().parent().prev().text();if("-"==n)a("#peso").hide(),a("#peso_editar").val(n);else{a("#peso").show(),n=n.replace("(",""),n=n.replace(")",""),n=n.replace(" ",""),n=n.replace("%",""),l=n,a("#peso_editar").val(n);var m=a(this).parent().attr("id");a(".maxweight-edit").attr("id",m)}var i="it",j=a(this).parent().parent().prev().prev().attr("title");"Enlazar a la actividad Tarea"==j&&(a("#nombre_editar").hide(),a("#label_nombre").hide())}a("#nombre_editar").val(j),console.log("0"),c(f,g,i),console.log("1"),a("#edit").modal({backdrop:!1}),console.log("2")}),a(document).on("click","#save_edit",function(){var c=a(this).attr("name"),d=a("#nombre_editar").val(),g=a("#peso_editar").val(),h=parseFloat(a(".maxweight-edit").attr("id"))+parseFloat(l),i=a("#calific").val(),j=a("#padre").val();if("-"==g&&(g=0),"99"==i)return void b({title:"Tipo de Calificacion no valida.",text:"No es posible editar una categoria con un tipo de calificacion diferente a Promedio Simple, Promedio Ponderado, o Calificacion mas alta.\n Por favor seleccione uno de estos tipos de calificacion",html:!0,type:"warning",confirmButtonColor:"#d51b23"});if(g>h)return void b({title:"Peso no valido.",text:"El peso ingresado supera el peso máximo posible de la categoria padre que es: "+h+"% \n Para crear un nuevo elemento primero configure los pesos de los demas.",html:!0,type:"warning",confirmButtonColor:"#d51b23"});if(""==d)return void b({title:"Ingrese el nuevo nombre del elemento",html:!0,type:"warning",confirmButtonColor:"#d51b23"});var k=a("#titulo").text();if("Ítem"==k.split(" ")[1]){var m="it";i=!1}else m="cat";var n=e();a.ajax({type:"POST",data:{course:n,element:c,type_e:m,newNombre:d,newPeso:g,newCalific:i,type:"editElement",parent:j},url:"../managers/grade_categories/grader_processing.php",success:function(c){c.error?b("Error",c.error,"error"):(b({title:"Listo",text:c.msg,type:"success",showCancelButton:!1,showConfirmButton:!1,timer:1300}),a("#edit").modal("hide"),f(n),console.log(c))},dataType:"json",cache:"false",error:function(a){console.log("AJAXerror"),console.log(a)}})}),a(document).on("click",".delete",function(){var c=a(this).parent().parent().parent().attr("id").split("_"),f=e(),g=c[1],h=c[0];if("cat"===h)var i="esta categoría";else var i="este item";var j="Esta seguro que desea eliminar "+i+"?";b({title:j,text:"Tenga en cuenta que NO SE PODRAN RECUPERAR ninguna de la notas que haya registrado en este elemento una vez borrado!",type:"warning",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Aceptar, Borrar "+i,cancelButtonText:"Cancelar",closeOnConfirm:!1,closeOnCancel:!1},function(a){a?d(g,f,h):b({title:"Cancelado",type:"error",showCancelButton:!1,showConfirmButton:!1,timer:1200})})}),a(document).on("click",".new",function(){var c=a(this).parent().parent().children().next(".maxweight").attr("id");if(c<=0)return void b({title:"No se pueden crear mas categorías o ítems en la categoria seleccionada.",text:"\n\r El peso de los elementos dentro de ésta suma 100%.\n\r Para crear un nuevo elemento primero configure los pesos de los demas.",html:!0,type:"warning",confirmButtonColor:"#d51b23"});a(".new").prop("disabled",!0),a(".delete").prop("disabled",!0),a(".edit").prop("disabled",!0);var d=a("<div class = 'divForm'>");d.load("../templates/categories_form.html");var h=a(this).parent().parent();h.append('<hr style = "border-top: 1px solid #ddd">'),h.append(d),window.setTimeout(function(){var c=h.attr("id");10==c&&(a("#divPeso").show(),a("#inputValor").on("blur",function(){var c=a(this).val(),d=parseInt(a(this).parent().parent().parent().parent().children().next(".maxweight").attr("id"));(c<0||c>d)&&(b({title:"El valor debe estar entre 0 y el peso máximo: "+d,text:"\n\rUsted ingresó: "+c,html:!0,type:"warning",confirmButtonColor:"#d51b23"}),a(this).val(""))}),a("#inputValor").on("keypress",function(a){var b=document.all?a.keyCode:a.which;if(8==b||46==b)return!0;var c=/[0-9]/,d=String.fromCharCode(b);return c.test(d)})),a("#tipoItem").on("change",function(){var b=a(this).prop("selectedIndex");1==b?a("#divTipeC").show():a("#divTipeC").hide()}),a("#save").on("click",function(){var b=a(this).parent().parent().parent().parent().attr("id"),c=a(this).parent().parent().parent().parent().parent().attr("id");c=c.split("_")[1],g(b,c)}),a("#cancel").on("click",function(){var a=e();f(a)})},400)})}}});